name: Download e Estrai Firmware Samsung

on:
  workflow_dispatch:
    inputs:
      firmware_url:
        description: "Inserisci l'URL diretto del firmware (.zip o .tar.md5)"
        required: true
        type: string

jobs:
  estrai_firmware:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Installa dipendenze necessarie
      run: |
        sudo apt update
        DEBIAN_FRONTEND=noninteractive sudo apt install -yq \
          unzip lz4 android-sdk-libsparse-utils attr ccache clang ffmpeg golang \
          libbrotli-dev libgtest-dev libprotobuf-dev libunwind-dev libpcre2-dev \
          libzstd-dev lld protobuf-compiler webp wget git

    - name: Scarica Firmware
      run: |
        rm -rf firmware extracted
        mkdir firmware
        echo "ðŸ“¥ Download del firmware da: ${{ github.event.inputs.firmware_url }}"
        curl -L "${{ github.event.inputs.firmware_url }}" -o firmware/firmware.zip

    - name: Estrai firmware.zip
      run: |
        unzip firmware/firmware.zip -d firmware
        rm -f firmware/firmware.zip
        ls firmware

    - name: Estrai file .tar.md5
      run: |
        cd firmware
        for f in *.tar.md5; do
          echo "Estrazione di $f"
          tar -xf "$f"
        done
        rm -f *.tar.md5
        ls

    - name: Estrai super.img.lz4
      run: |
        cd firmware
        if ls super.img.lz4 1> /dev/null 2>&1; then
          lz4 -d super.img.lz4 super.img.sparse
          rm -f super.img.lz4
        fi
        mv super.img.sparse ../super.img.sparse

    - name: Converti sparse in raw
      run: |
        simg2img super.img.sparse super.img
        rm -f super.img.sparse

    - name: Installa lpunpack da mirror GitHub
      run: |
        git clone https://github.com/Exynos-nibba/lpunpack-lpmake-mirror.git
        sudo mv lpunpack-lpmake-mirror/lpunpack /usr/local/bin/lpunpack
        sudo chmod +x /usr/local/bin/lpunpack

    - name: Estrai partizioni da super.img
      run: |
        mkdir extracted
        lpunpack super.img extracted/
        ls extracted

    - name: Comprimi partizioni estratte
      run: |
        zip -r -9 firmware_parts.zip extracted
        ls -lh firmware_parts.zip

    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SF_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan frs.sourceforge.net >> ~/.ssh/known_hosts

    - name: Upload partizioni a SourceForge
      run: |
        scp firmware_parts.zip thewinner02@frs.sourceforge.net:/home/frs/project/oneui-ports/test/
