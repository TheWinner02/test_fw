name: Estrai Partizioni da Firmware Samsung

on:
  workflow_dispatch:
    inputs:
      firmware_url:
        description: "ðŸ”— Inserisci il link di download diretto del firmware (.tar.md5.zip)"
        required: true
        type: string
      base_name:
        description: "ðŸ“ Inserisci il nome base per i file di output (es. A53, S23FE)"
        required: true
        type: string

jobs:
  extract_firmware:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Installa Dipendenze Necessarie
      run: |
        sudo apt-get update
        sudo apt-get install -y unzip lz4 python3 android-sdk-libsparse-utils git
        git clone https://android.googlesource.com/platform/system/core.git
        sudo cp core/fs_mgr/libsnapshot/lpunpack /usr/local/bin/ || true
        sudo chmod +x /usr/local/bin/lpunpack

    - name: Scarica Firmware
      run: |
        rm -rf firmware
        mkdir firmware
        echo "ðŸ“¦ Scarico firmware da:"
        echo "${{ github.event.inputs.firmware_url }}"
        curl -L "${{ github.event.inputs.firmware_url }}" -o firmware.zip

    - name: Estrai firmware.zip
      run: |
        unzip -q firmware.zip -d firmware
        rm firmware.zip

    - name: Estrai super.img.lz4 dal TAR
      run: |
        cd firmware
        tar -xf AP*.tar.md5 super.img.lz4 || echo "âš ï¸ Nessun super.img.lz4 trovato!"
        rm -f AP*.tar.md5

    - name: Decomprimi super.img.lz4
      run: |
        cd firmware
        lz4 -d super.img.lz4 super.img || echo "âš ï¸ super.img.lz4 non trovato o giÃ  estratto"
        rm -f super.img.lz4 || true

    - name: Suddividi super.img in partizioni
      run: |
        mkdir extracted
        lpunpack firmware/super.img extracted/ || echo "âš ï¸ Impossibile estrarre super.img"
        ls -lh extracted || true

    - name: Comprimi Partizioni in ZIP
      run: |
        cd extracted
        zip -r "../${{ github.event.inputs.base_name }}_partizioni.zip" .
        cd ..
        ls -lh "${{ github.event.inputs.base_name }}_partizioni.zip"

    - name: Setup SSH per SourceForge
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SF_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan frs.sourceforge.net >> ~/.ssh/known_hosts

    - name: Upload su SourceForge
      run: |
        scp "${{ github.event.inputs.base_name }}_partizioni.zip" thewinner02@frs.sourceforge.net:/home/frs/project/oneui-ports/test/
