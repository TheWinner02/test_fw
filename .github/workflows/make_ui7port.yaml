name: Make OneUI 7.0 Port for Universal7885

on:
  workflow_dispatch:
    inputs:
      firmware_url:
        description: "Inserisci l'URL diretto del firmware EXYNOS (.zip o .tar.md5)"
        required: true
        type: string
      device_name:
        description: "Inserisci il nome del dispositivo della base"
        required: true
        type: string
      fs_type:
        description: "Specifica il tipo di filesystem della base (ext4, f2fs o erofs)"
        required: true
        type: string

jobs:
  OneUI7_Auto_Port_Universal7885:
    runs-on: ubuntu-24.04

    steps:
      - name: üì¶ Checkout Repository
        uses: actions/checkout@v4

      # üßπ Pulizia extra disco (nuovi step)
      - name: Free disk space (1/3)
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          sudo docker builder prune -a

      - name: Free disk space (2/3)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true

      - name: Free disk space (3/3)
        uses: rokibhasansagar/slimhub_actions@main
        with:
          retain: 'compiler_cmake'

      # üìä Crea funzione monitor_spazio
      - name: üìä Crea funzione monitor_spazio
        run: |
          echo '#!/bin/bash
          FREE=$(df --output=avail -BG / | tail -1 | sed "s/G//")
          echo "üìä Spazio libero: ${FREE} GB"
          if [ "$FREE" -lt 2 ]; then
            echo "‚ùå ERRORE: spazio insufficiente (<2 GB)"
            exit 1
          fi' | sudo tee /usr/local/bin/monitor_spazio > /dev/null
          sudo chmod +x /usr/local/bin/monitor_spazio

      # ‚öôÔ∏è Imposta nome dispositivo
      - name: üì± Imposta DEVICE_NAME
        run: |
          DEVICE_NAME="${{ github.event.inputs.device_name }}"
          echo "üì± Nome dispositivo: $DEVICE_NAME"
          echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV

      # ‚öôÔ∏è Installazione dipendenze
      - name: ‚öôÔ∏è Installa dipendenze necessarie
        run: |
          sudo apt update
          DEBIAN_FRONTEND=noninteractive sudo apt install -yq \
            unzip lz4 android-sdk-libsparse-utils attr zip wget git tar \
            f2fs-tools erofs-utils e2fsprogs python3 brotli rsync fuse3
          sudo apt install -y linux-modules-extra-$(uname -r)
          sudo modprobe f2fs || echo "‚ö†Ô∏è Modulo F2FS non disponibile"
          sudo modprobe erofs || echo "‚ö†Ô∏è Modulo EROFS non disponibile"
          monitor_spazio
          
      # üì• Download firmware
      - name: üì• Scarica firmware
        run: |
          mkdir -p ACK
          echo "‚û°Ô∏è Download del firmware da: ${{ github.event.inputs.firmware_url }}"
          curl -L "${{ github.event.inputs.firmware_url }}" -o ACK/base.zip --progress-bar
          ls -lh ACK
          monitor_spazio
          
      # ‚öôÔ∏è Copia file di configurazione personalizzati
      - name: ‚öôÔ∏è Prepara file di configurazione per build system.img
        run: |
          cd ACK
          mkdir -p config
          cp -a fix/OneUI/UI7.0/Config/* config/ || echo "‚ÑπÔ∏è Nessun file config trovato"
          ls -lh config/
          monitor_spazio
          
      # üì¶ Estrazione ZIP/TAR.MD5
      - name: üì¶ Estrai archivio principale
        run: |
          cd ACK
          if file base.zip | grep -q "gzip compressed"; then
            tar -xf base.zip
          else
            unzip base.zip
          fi
          rm -f base.zip
          monitor_spazio

      - name: üîπ Estrai file .tar.md5
        run: |
          cd ACK
          tar --wildcards -xf *.tar.md5 'super.*.*'
          rm -f *.tar.md5
          monitor_spazio

      # üî∏ Decompressione super.img.lz4
      - name: üî∏ Decomprimi super.img.lz4
        run: |
          cd ACK
          if [ -f super.img.lz4 ]; then
            lz4 -d super.img.lz4 super.img.sparse
            rm -f super.img.lz4
          fi
          monitor_spazio

      # üîÅ Conversione sparse ‚Üí raw
      - name: üîÅ Converti sparse in raw
        run: |
          cd ACK
          simg2img super.img.sparse super.img
          rm -f super.img.sparse
          monitor_spazio

      # üß∞ LPUNPACK
      - name: üß∞ Scarica e prepara lpunpack
        run: |
          cd ACK
          git clone https://github.com/unix3dgforce/lpunpack.git
          monitor_spazio

      # üóÇÔ∏è Estrazione partizioni da super.img
      - name: üóÇÔ∏è Estrai partizioni
        run: |
          cd ACK
          mkdir out
          python3 lpunpack/lpunpack.py -p product,system super.img out/
          rm -f super.img
          ls -lh out
          monitor_spazio

      # üß© Estrazione offline system e product (rilevamento automatico layout e filesystem)
      - name: üß© Estrazione offline system e product
        run: |
          cd ACK
          mkdir -p system_modified product_modified tmp_out

          for IMG in out/system.img out/product.img; do
            PART=$(basename $IMG .img)
            echo "üìÇ Estrazione $PART senza mount"
            
            mkdir -p tmp_out

            # Rilevamento automatico FS
            FS="${{ github.event.inputs.fs_type }}"
            echo "üîç filesystem rilevato; $FS"

            case "$FS" in
              f2fs|ext4)
                echo "üîπ Filesystem $FS, mount read-only temporaneo"
                sudo mount -o ro,loop "$IMG" tmp_out || true
                ;;
              erofs)
                echo "üîπ Filesystem EROFS, uso fuse.erofs"
                fuse.erofs "$IMG" tmp_out
                ;;
              *)
                echo "‚ö†Ô∏è Filesystem non riconosciuto, salto $IMG"
                continue
                ;;
            esac

            if [[ "$PART" == "system" ]]; then
              echo "üì¶ Copio partizione system"
              sudo cp -a --preserve=all tmp_out/system/* system_modified/
            else
              sudo cp -a --preserve=all tmp_out/* product_modified/
              echo "üì¶ Copio partizione product"
            fi

            sudo find system_modified product_modified -exec chown -h $(whoami):$(whoami) {} \;

            if [[ "$FS" == "f2fs" || "$FS" == "ext4" ]]; then
              sudo umount tmp_out || true
            fi
            sudo rm -rf tmp_out/*
          done

          sudo rm -f out/*.img
          echo "‚úÖ Estrazione offline completata con rilevamento automatico layout"
          monitor_spazio

      # ‚öôÔ∏è Applica modifiche OneUI 7.0
      - name: ‚öôÔ∏è Applica patch OneUI
        run: |
          cd ACK
          echo "üì¶ Applico patch"

          # debloat
          chmod +x ../script/system/ui7_debloat.sh
          sudo bash ../script/system/ui7_debloat.sh
          
          # product
          ls product_modified/app
          sudo cp -a --preserve=all product_modified/app/Trichrome* system_modified/system/app/
          sudo cp -a --preserve=all product_modified/app/WebView* system_modified/system/app/
          sudo cp -a --preserve=all product_modified/priv-app/Ai* system_modified/system/priv-app/
          sudo cp -a --preserve=all product_modified/priv-app/Phonesky system_modified/system/priv-app/
          sudo cp -a --preserve=all product_modified/priv-app/PrivateComputeServices system_modified/system/priv-app/

          # system
          chmod +x ../script/system/ff.sh
          sudo bash ../script/system/ff.sh
          chmod +x ../script/system/prop.sh
          sudo bash ../script/system/prop.sh

          # common
          sudo cp -a --preserve=all ../common/product/overlay/* product_modified/overlay/
          sudo cp -a --preserve=all ../common/system/* system_modified/
          
          echo "‚úÖ Patch applicate"

      # üèóÔ∏è Ricompila system.img con configurazioni personalizzate
      - name: üèóÔ∏è Ricompila system.img con config e dimensione precisa
        run: |
          cd ACK
          echo "üß± Creazione system.img con context e config personalizzati..."
          
          # Applica mke2fs.conf se presente
          if [ -f config/mke2fs.conf ]; then
            sudo cp config/mke2fs.conf /etc/mke2fs.conf
            echo "‚úÖ mke2fs.conf applicato"
          fi

          # Crea system.img con filecontext e config precisi
          make_ext4fs -s -T 0 \
            -S config/system_file_contexts.txt \
            -C config/system_filesystem_config.txt \
            -l 4294967296 -a system out/system.img system_modified/

          # Applica eventuali feature aggiuntive definite in system_filesystem_features.txt
          if [ -f config/system_filesystem_features.txt ]; then
            echo "‚öôÔ∏è Applico system_filesystem_features.txt..."
            FEATURES=$(cat config/system_filesystem_features.txt | tr '\n' ',')
            tune2fs -O $FEATURES out/system.img || echo "‚ö†Ô∏è Feature non applicabili, continuo..."
          fi

          img2simg out/system.img out/system_sparse.img
          sudo rm -rf out/system.img system_modified
          monitor_spazio

      # üîÑ Converti system_sparse.img ‚Üí .new.dat
      - name: üîÑ Converti system_sparse.img ‚Üí .new.dat
        run: |
          cd ACK
          git clone https://github.com/xpirt/img2sdat.git
          cd img2sdat
          sed -i 's/import imp/import importlib as imp/' common.py
          python3 img2sdat.py ../out/system_sparse.img -o ../out -v 4
          sudo rm -f ../out/system_sparse.img
          cd ..
          monitor_spazio

      # üóúÔ∏è Compressione output
      - name: üóúÔ∏è Comprimi risultati finali
        run: |
          cd ACK
          mkdir -p out/product
          sudo cp -a --preserve=all product_modified/* out/product/
          sudo rm -rf product_modified
          sudo cp -a --preserve=all ../common/vendor out/
          sudo cp -a --preserve=all ../common/device out/
          sudo cp -a --preserve=all ../common/inf/$DEVICE_NAME/* out/
          cd out
          sudo zip -r -9 ../Port.zip *
          cd ..
          sudo rm -rf out
          ls -lh Port.zip
          monitor_spazio

      # ‚òÅÔ∏è Upload su SourceForge
      - name: ‚òÅÔ∏è Upload su SourceForge
        run: |
          cd ACK
          mkdir -p ~/.ssh
          echo "${{ secrets.SF_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan frs.sourceforge.net >> ~/.ssh/known_hosts
          scp Port.zip thewinner02@frs.sourceforge.net:/home/frs/project/oneui-ports/test/
          echo "‚úÖ Upload completato su SourceForge"
          monitor_spazio
