name: Make OneUI 7.0 Port for Universal7885

on:
  workflow_dispatch:
    inputs:
      firmware_url:
        description: "Inserisci l'URL diretto del firmware EXYNOS (.zip o .tar.md5)"
        required: true
        type: string
      fs_type:
        description: "Specifica il tipo di filesystem della base (ext4, f2fs o erofs)"
        required: true
        type: string

jobs:
  OneUI7_Auto_Port_Universal7885:
    runs-on: ubuntu-22.04

    steps:
    - name: üì¶ Checkout Repository
      uses: actions/checkout@v4

    # üßπ PULIZIA E SPAZIO
    - name: üîß Libera spazio su disco
      run: |
        echo "üßπ Rimozione pacchetti non necessari..."
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        sudo docker system prune -a -f
        sudo apt clean
        df -h /

    - name: üìä Crea funzione monitor_spazio
      run: |
        echo '#!/bin/bash
        FREE=$(df --output=avail -BG / | tail -1 | sed "s/G//")
        echo "üìä Spazio libero: ${FREE} GB"
        if [ "$FREE" -lt 2 ]; then
          echo "‚ùå ERRORE: spazio insufficiente (<2 GB)"
          exit 1
        fi' | sudo tee /usr/local/bin/monitor_spazio > /dev/null
        sudo chmod +x /usr/local/bin/monitor_spazio

    # ‚öôÔ∏è INSTALLAZIONE DIPENDENZE
    - name: ‚öôÔ∏è Installa dipendenze necessarie
      run: |
        sudo apt update
        DEBIAN_FRONTEND=noninteractive sudo apt install -yq \
          unzip lz4 android-sdk-libsparse-utils attr zip wget git tar f2fs-tools erofs-utils e2fsprogs python3 brotli rsync fuse3
        wget -O /usr/local/bin/imgextractor.py https://raw.githubusercontent.com/xpirt/imgextractor/master/imgextractor.py
        chmod +x /usr/local/bin/imgextractor.py
        monitor_spazio

    # üì• DOWNLOAD FIRMWARE
    - name: üì• Scarica firmware
      run: |
        mkdir -p ACK
        echo "‚û°Ô∏è Download del firmware da: ${{ github.event.inputs.firmware_url }}"
        curl -L "${{ github.event.inputs.firmware_url }}" -o ACK/base.zip --progress-bar
        ls -lh ACK
        monitor_spazio

    # üì¶ ESTRAZIONE ZIP/TAR.MD5
    - name: üì¶ Estrai archivio principale
      run: |
        cd ACK
        if file base.zip | grep -q "gzip compressed"; then
          echo "üì¶ File TAR.MD5 rilevato, estrazione..."
          tar -xf base.zip
        else
          echo "üì¶ File ZIP rilevato, estrazione..."
          unzip base.zip
        fi
        rm -f base.zip
        echo "‚úÖ Estrazione completata"
        monitor_spazio

    - name: üîπ Estrai file .tar.md5
      run: |
        cd ACK
        echo "üìÇ Estrazione di .tar.md5"
        tar --wildcards -xf *.tar.md5 'super.*.*'
        rm -f *.tar.md5
        echo "‚úÖ File TAR.MD5 estratti"
        monitor_spazio

    # üî∏ DECOMPRESSIONE SUPER.IMG.LZ4
    - name: üî∏ Decomprimi super.img.lz4
      run: |
        cd ACK
        if [ -f super.img.lz4 ]; then
          echo "üîπ Decompressione super.img.lz4"
          lz4 -d super.img.lz4 super.img.sparse
          rm -f super.img.lz4
        fi
        monitor_spazio

    # üîÅ CONVERSIONE SPARSE ‚Üí RAW
    - name: üîÅ Converti sparse in raw
      run: |
        cd ACK
        echo "üîÅ Conversione super.img.sparse ‚Üí super.img"
        simg2img super.img.sparse super.img
        rm -f super.img.sparse
        ls -lh super.img
        monitor_spazio

    # üß∞ LPUNPACK
    - name: üß∞ Scarica e prepara lpunpack
      run: |
        git clone https://github.com/unix3dgforce/lpunpack.git
        monitor_spazio

    # üóÇÔ∏è ESTRAZIONE PARTIZIONI
    - name: üóÇÔ∏è Estrai partizioni da super.img
      run: |
        cd ACK
        mkdir out
        echo "üìÇ Estrazione da super.img..."
        python3 ../lpunpack/lpunpack.py -p product,system super.img out/
        rm -f super.img
        ls -lh out
        monitor_spazio

    # üß© MONTA SYSTEM E PRODUCT IN BASE AL TIPO DI FILESYSTEM
    - name: üß© Monta system.img e product.img
      run: |
        cd ACK
        TYPE="${{ github.event.inputs.fs_type }}"

        EXT4_FS="ext4"
        F2FS_FS="f2fs"
        EROFS_FS="erofs"

        echo "‚öôÔ∏è Filesystem rilevato per system.img: $TYPE"
        mkdir -p system_mount system_modified product_mount product_modified

        if [ "$TYPE" = "$EXT4_FS" ]; then
          echo "üîπ Montaggio EXT4..."
          sudo mount -t ext4 -o loop out/system.img system_mount
          sudo mount -t ext4 -o loop out/product.img product_mount
          sudo rsync -aHAX system_mount/ system_modified/
          sudo rsync -aHAX product_mount/ product_modified/

        elif [ "$TYPE" = "$F2FS_FS" ]; then
          echo "üîπ Filesystem F2FS rilevato ‚Äî mount diretto non supportato su GitHub, uso estrazione fallback."
          echo "üì¶ Estrazione system.img..."
          if ! sudo mount -t f2fs -o loop out/system.img system_mount &>/dev/null; then
            echo "‚ö†Ô∏è Kernel non supporta F2FS ‚Äî estrazione con imgextractor.py..."
            python3 /usr/local/bin/imgextractor.py out/system.img system_modified || true
          else
            sudo rsync -aHAX system_mount/ system_modified/
          fi

          echo "üì¶ Estrazione product.img..."
          if ! sudo mount -t f2fs -o loop out/product.img product_mount &>/dev/null; then
            echo "‚ö†Ô∏è Kernel non supporta F2FS ‚Äî estrazione con imgextractor.py..."
            python3 /usr/local/bin/imgextractor.py out/product.img product_modified || true
          else
            sudo rsync -aHAX product_mount/ product_modified/
          fi

          sudo umount system_mount || true
          sudo umount product_mount || true
          sudo rm -rf system_mount product_mount
          echo "‚úÖ Estrazione completata in system_modified/ e product_modified/"

        elif [ "$TYPE" = "$EROFS_FS" ]; then
          echo "üîπ Montaggio EROFS tramite FUSE..."
          mkdir -p fuse_sys fuse_prod
          erofsfuse out/system.img fuse_sys
          erofsfuse out/product.img fuse_prod
          sudo rsync -aHAX fuse_sys/ system_modified/
          sudo rsync -aHAX fuse_prod/ product_modified/
          fusermount -u fuse_sys || true
          fusermount -u fuse_prod || true
          rm -rf fuse_sys fuse_prod

        else
          echo "‚ö†Ô∏è Tipo sconosciuto ($TYPE), provo mount automatico..."
          sudo mount -o loop out/system.img system_mount || true
          sudo mount -o loop out/product.img product_mount || true
          sudo rsync -aHAX system_mount/ system_modified/ || true
          sudo rsync -aHAX product_mount/ product_modified/ || true
        fi

        sudo umount system_mount || true
        sudo umount product_mount || true
        sudo rm -rf system_mount product_mount

        echo "‚úÖ Contenuto estratto in system_modified/ e product_modified/"
        monitor_spazio
