name: Make OneUI 7.0 Port for Universal7885

on:
  workflow_dispatch:
    inputs:
      firmware_url:
        description: "Inserisci l'URL diretto del firmware EXYNOS (.zip o .tar.md5)"
        required: true
        type: string
      fs_type:
        description: "Specifica il tipo di filesystem della base (ext4, f2fs o erofs)"
        required: true
        type: string

jobs:
  OneUI7_Auto_Port_Universal7885:
    runs-on: ubuntu-24.04

    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4

      # ğŸ§¹ Pulizia e spazio
      - name: ğŸ”§ Libera spazio su disco
        run: |
          echo "ğŸ§¹ Rimozione pacchetti non necessari..."
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker system prune -a -f
          sudo apt clean
          df -h /

      - name: ğŸ“Š Crea funzione monitor_spazio
        run: |
          echo '#!/bin/bash
          FREE=$(df --output=avail -BG / | tail -1 | sed "s/G//")
          echo "ğŸ“Š Spazio libero: ${FREE} GB"
          if [ "$FREE" -lt 2 ]; then
            echo "âŒ ERRORE: spazio insufficiente (<2 GB)"
            exit 1
          fi' | sudo tee /usr/local/bin/monitor_spazio > /dev/null
          sudo chmod +x /usr/local/bin/monitor_spazio

      # âš™ï¸ Installazione dipendenze
      - name: âš™ï¸ Installa dipendenze necessarie
        run: |
          sudo apt update
          DEBIAN_FRONTEND=noninteractive sudo apt install -yq \
            unzip lz4 android-sdk-libsparse-utils attr zip wget git tar \
            f2fs-tools erofs-utils e2fsprogs python3 brotli fuse3
          sudo apt install -y linux-modules-extra-$(uname -r)
          sudo modprobe f2fs || echo "âš ï¸ Modulo F2FS non disponibile"
          sudo modprobe erofs || echo "âš ï¸ Modulo EROFS non disponibile"
          monitor_spazio

      # ğŸ“¥ Download firmware
      - name: ğŸ“¥ Scarica firmware
        run: |
          mkdir -p ACK
          echo "â¡ï¸ Download del firmware da: ${{ github.event.inputs.firmware_url }}"
          curl -L "${{ github.event.inputs.firmware_url }}" -o ACK/base.zip --progress-bar
          ls -lh ACK
          monitor_spazio

      # ğŸ“¦ Estrazione ZIP/TAR.MD5
      - name: ğŸ“¦ Estrai archivio principale
        run: |
          cd ACK
          if file base.zip | grep -q "gzip compressed"; then
            tar -xf base.zip
          else
            unzip base.zip
          fi
          rm -f base.zip
          monitor_spazio

      - name: ğŸ”¹ Estrai file .tar.md5
        run: |
          cd ACK
          tar --wildcards -xf *.tar.md5 'super.*.*'
          rm -f *.tar.md5
          monitor_spazio

      # ğŸ”¸ Decompressione super.img.lz4
      - name: ğŸ”¸ Decomprimi super.img.lz4
        run: |
          cd ACK
          if [ -f super.img.lz4 ]; then
            lz4 -d super.img.lz4 super.img.sparse
            rm -f super.img.lz4
          fi
          monitor_spazio

      # ğŸ” Conversione sparse â†’ raw
      - name: ğŸ” Converti sparse in raw
        run: |
          cd ACK
          simg2img super.img.sparse super.img
          rm -f super.img.sparse
          monitor_spazio

      # ğŸ§° LPUNPACK
      - name: ğŸ§° Scarica e prepara lpunpack
        run: |
          git clone https://github.com/unix3dgforce/lpunpack.git
          monitor_spazio

      # ğŸ—‚ï¸ Estrazione partizioni da super.img
      - name: ğŸ—‚ï¸ Estrai partizioni
        run: |
          cd ACK
          mkdir out
          python3 ../lpunpack/lpunpack.py -p product,system super.img out/
          rm -f super.img
          ls -lh out
          monitor_spazio

      # ğŸ§© Estrazione offline system e product
      - name: ğŸ§© Estrazione offline system e product
        run: |
          cd ACK
          mkdir -p system_modified/product_modified tmp_out

          for IMG in out/system.img out/product.img; do
            PART=$(basename $IMG .img)
            echo "ğŸ“‚ Estrazione $PART senza mount"

            rm -rf tmp_out/*
            mkdir -p tmp_out

            FS=$(file $IMG | grep -oE 'F2FS|ext4|EroFS' | tr '[:upper:]' '[:lower:]')

            case "$FS" in
              f2fs|ext4)
                echo "ğŸ”¹ Filesystem $FS, mount read-only temporaneo"
                sudo mount -o ro,loop $IMG tmp_out || true
                ;;
              erofs)
                echo "ğŸ”¹ Filesystem EROFS, fuse.erofs"
                fuse.erofs $IMG tmp_out
                ;;
              *)
                echo "âš ï¸ Filesystem non riconosciuto, salto $IMG"
                continue
                ;;
            esac

            if [[ "$PART" == "system" ]]; then
              DEST="system_modified/system"
            else
              DEST="product_modified"
            fi

            mkdir -p $DEST
            echo "ğŸ“‚ Copia contenuto in $DEST"
            sudo cp -a --preserve=all tmp_out/. $DEST/
            sudo find $DEST/ -exec chown -h $USER:$USER {} \;

            if [[ "$FS" == "f2fs" || "$FS" == "ext4" ]]; then
              sudo umount tmp_out || true
            fi
            rm -rf tmp_out/*
          done

          echo "âœ… Estrazione offline completata"
          monitor_spazio

      # âš™ï¸ Applica modifiche OneUI 7.0
      - name: âš™ï¸ Applica patch OneUI
        run: |
          cd ACK
          chmod +x ../script/system/ui7_debloat.sh
          sudo bash ../script/system/ui7_debloat.sh

      # ğŸ—ï¸ Ricompilazione system.img
      - name: ğŸ—ï¸ Ricompila system.img
        run: |
          cd ACK
          dd if=/dev/zero of=out/system.img bs=1M count=4096 status=progress
          mkfs.ext4 -F -L system out/system.img
          sudo mkdir -p /mnt/system
          sudo mount -o loop out/system.img /mnt/system
          sudo cp -a --preserve=all system_modified/. /mnt/system/
          sudo sync
          sudo umount /mnt/system
          sudo rm -rf system_modified
          img2simg out/system.img out/system_sparse.img
          sudo rm -f out/system.img
          monitor_spazio

      # ğŸ”„ Converti system_sparse.img â†’ .new.dat
      - name: ğŸ”„ Converti system_sparse.img â†’ .new.dat
        run: |
          cd ACK
          git clone https://github.com/xpirt/img2sdat.git
          cd img2sdat
          sed -i 's/import imp/import importlib as imp/' common.py
          python3 img2sdat.py ../out/system_sparse.img -o ../out -v 4
          sudo rm -f ../out/system_sparse.img
          cd ..
          monitor_spazio

      # ğŸ—œï¸ Compressione output
      - name: ğŸ—œï¸ Comprimi risultati finali
        run: |
          cd ACK
          mkdir -p out/product
          sudo cp -a --preserve=all product_modified/* out/product/
          sudo rm -rf product_modified
          cd out
          zip -9 ../Port.zip *
          cd ..
          sudo rm -rf out
          ls -lh Port.zip
          monitor_spazio

      # â˜ï¸ Upload su SourceForge
      - name: â˜ï¸ Upload su SourceForge
        run: |
          cd ACK
          mkdir -p ~/.ssh
          echo "${{ secrets.SF_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan frs.sourceforge.net >> ~/.ssh/known_hosts
          scp Port.zip thewinner02@frs.sourceforge.net:/home/frs/project/oneui-ports/test/
          echo "âœ… Upload completato su SourceForge"
          monitor_spazio
