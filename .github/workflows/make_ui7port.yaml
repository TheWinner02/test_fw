name: Make OneUI 7.0 Port for Universal7885

on:
  workflow_dispatch:
    inputs:
      firmware_url:
        description: "Inserisci l'URL diretto del firmware EXYNOS (.zip o .tar.md5)"
        required: true
        type: string

jobs:
  OneUI7_Auto_Port_Universal7885:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¦ Checkout Repository
      uses: actions/checkout@v4

    # ğŸ§¹ PULIZIA E SPAZIO
    - name: ğŸ”§ Libera spazio su disco
      run: |
        echo "ğŸ§¹ Rimozione pacchetti non necessari..."
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        sudo docker system prune -a -f
        sudo apt clean
        df -h /

    - name: ğŸ“Š Crea funzione monitor_spazio
      run: |
        echo '#!/bin/bash
        FREE=$(df --output=avail -BG / | tail -1 | sed "s/G//")
        echo "ğŸ“Š Spazio libero: ${FREE} GB"
        if [ "$FREE" -lt 2 ]; then
          echo "âŒ ERRORE: spazio insufficiente (<2 GB)"
          exit 1
        fi' | sudo tee /usr/local/bin/monitor_spazio > /dev/null
        sudo chmod +x /usr/local/bin/monitor_spazio

    # âš™ï¸ INSTALLAZIONE DIPENDENZE
    - name: âš™ï¸ Installa dipendenze necessarie
      run: |
        sudo apt update
        DEBIAN_FRONTEND=noninteractive sudo apt install -yq \
          unzip lz4 android-sdk-libsparse-utils attr zip wget git tar f2fs-tools erofs-utils e2fsprogs python3 brotli rsync
        monitor_spazio

    # ğŸ“¥ DOWNLOAD FIRMWARE
    - name: ğŸ“¥ Scarica firmware
      run: |
        mkdir -p ACK
        echo "â¡ï¸ Download del firmware da: ${{ github.event.inputs.firmware_url }}"
        curl -L "${{ github.event.inputs.firmware_url }}" -o ACK/base.zip --progress-bar
        ls -lh ACK
        monitor_spazio

    # ğŸ“¦ ESTRAZIONE ZIP/TAR.MD5
    - name: ğŸ“¦ Estrai archivio principale
      run: |
        cd ACK
        if file base.zip | grep -q "gzip compressed"; then
          echo "ğŸ“¦ File TAR.MD5 rilevato, estrazione..."
          tar -xf base.zip
        else
          echo "ğŸ“¦ File ZIP rilevato, estrazione..."
          unzip base.zip
        fi
        rm -f base.zip
        echo "âœ… Estrazione completata"
        monitor_spazio

    - name: ğŸ”¹ Estrai file .tar.md5
      run: |
        cd ACK
        echo "ğŸ“‚ Estrazione di .tar.md5"
        tar --wildcards -xf *.tar.md5 'super.*.*'
        rm -f *.tar.md5
        echo "âœ… File TAR.MD5 estratti"
        monitor_spazio

    # ğŸ”¸ DECOMPRESSIONE SUPER.IMG.LZ4
    - name: ğŸ”¸ Decomprimi super.img.lz4
      run: |
        cd ACK
        if [ -f super.img.lz4 ]; then
          echo "ğŸ”¹ Decompressione super.img.lz4"
          lz4 -d super.img.lz4 super.img.sparse
          rm -f super.img.lz4
        fi
        monitor_spazio

    # ğŸ” CONVERSIONE SPARSE â†’ RAW
    - name: ğŸ” Converti sparse in raw
      run: |
        cd ACK
        echo "ğŸ” Conversione super.img.sparse â†’ super.img"
        simg2img super.img.sparse super.img
        rm -f super.img.sparse
        ls -lh super.img
        monitor_spazio

    # ğŸ§° LPUNPACK
    - name: ğŸ§° Scarica e prepara lpunpack
      run: |
        git clone https://github.com/unix3dgforce/lpunpack.git
        monitor_spazio

    # ğŸ—‚ï¸ ESTRAZIONE PARTIZIONI
    - name: ğŸ—‚ï¸ Estrai partizioni da super.img
      run: |
        cd ACK
        mkdir out
        echo "ğŸ“‚ Estrazione da super.img..."
        python3 ../lpunpack/lpunpack.py -p product,system super.img out/
        rm -f super.img
        ls -lh out
        monitor_spazio

    # ğŸ” RILEVA FILESYSTEM
    - name: âš™ï¸ Rileva filesystem di system.img
      id: detect
      run: |
        cd ACK
        TYPE=$(file out/system.img | grep -oE 'ext4|f2fs|erofs' || echo "unknown")
        echo "âœ… Filesystem rilevato: $TYPE"
        echo "type=$TYPE" >> $GITHUB_OUTPUT
        monitor_spazio

    # ğŸ§© MONTA E MODIFICA SYSTEM E PRODUCT
    - name: ğŸ§© Monta e modifica system.img
      run: |
        cd ACK
        TYPE=${{ steps.detect.outputs.type }}
        echo "âš™ï¸ Montaggio filesystem ($TYPE)..."
        mkdir -p system_mount system_modified product_mount product_modified

        if [ "$TYPE" = "ext4" ]; then
          sudo mount -t ext4 -o loop out/system.img system_mount
          sudo mount -t ext4 -o loop out/product.img product_mount
        elif [ "$TYPE" = "f2fs" ]; then
          sudo mount -t f2fs -o loop out/system.img system_mount
          sudo mount -t f2fs -o loop out/product.img product_mount
        elif [ "$TYPE" = "erofs" ]; then
          sudo mount -t erofs -o loop out/system.img system_mount
          sudo mount -t erofs -o loop out/product.img product_mount
        else
          echo "âš ï¸ Tipo sconosciuto, provo mount automatico..."
          sudo mount -o loop out/system.img system_mount || true
          sudo mount -o loop out/product.img product_mount || true
        fi

        echo "ğŸ“‚ Copia contenuto..."
        sudo rsync -aHAX system_mount/ system_modified/
        sudo rsync -aHAX product_mount/ product_modified/
        sudo sync
        sudo umount system_mount || true
        sudo umount product_mount || true
        sudo rm -rf system_mount product_mount
        echo "âœ… Contenuto estratto in system_modified/"
        monitor_spazio

    # âš™ï¸ APPLICA MODIFICHE
    - name: âš™ï¸ Applica modifiche OneUI 7.0
      run: |
        cd ACK
        echo "âš™ï¸ OneUI 7.0 Port AutoBuild..."
        chmod +x ../script/system/ui7_debloat.sh
        sudo bash ../script/system/ui7_debloat.sh

    # ğŸ—ï¸ RICOMPILA SYSTEM.IMG
    - name: ğŸ—ï¸ Ricompila system.img in ext4
      run: |
        cd ACK
        echo "âš™ï¸ Ricompilazione filesystem forzata in ext4"
        dd if=/dev/zero of=out/system.img bs=1M count=4096 status=progress
        mkfs.ext4 -F -L system out/system.img

        sudo mkdir -p /mnt/system
        sudo mount -o loop out/system.img /mnt/system
        echo "ğŸ“‚ Copia file in system..."
        sudo rsync -aHAX system_modified/* /mnt/system/
        sudo sync
        sudo umount /mnt/system
        sudo rm -rf /mnt/system system_modified

        echo "ğŸ” Conversione in sparse image..."
        img2simg out/system.img out/system_sparse.img
        sudo rm -f out/system.img
        ls -lh out/system_sparse.img
        monitor_spazio

    # ğŸ”„ CONVERTI IN .NEW.DAT
    - name: ğŸ”„ Converti system_sparse.img â†’ .new.dat
      run: |
        cd ACK
        git clone https://github.com/xpirt/img2sdat.git
        cd img2sdat
        python3 img2sdat.py ../out/system_sparse.img -o ../out -v 4
        sudo rm -f ../out/system_sparse.img && cd ..
        ls -lh out/system.new.dat
        monitor_spazio

    # ğŸ—œï¸ COMPRESSIONE OUTPUT
    - name: ğŸ—œï¸ Comprimi risultati finali
      run: |
        cd ACK
        echo "ğŸ—œï¸ Compressione file..."
        mkdir out/product
        sudo rsync -aHAX product_modified/* out/product/ && sudo rm -rf product_modified
        cd out
        zip -9 ../Port.zip *
        cd .. && sudo rm -rf out
        ls -lh Port.zip
        monitor_spazio

    # â˜ï¸ UPLOAD SU SOURCEFORGE
    - name: ğŸ” Configura SSH e carica su SourceForge
      run: |
        cd ACK
        mkdir -p ~/.ssh
        echo "${{ secrets.SF_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan frs.sourceforge.net >> ~/.ssh/known_hosts
        scp Port.zip thewinner02@frs.sourceforge.net:/home/frs/project/oneui-ports/test/
        echo "âœ… Upload completato su SourceForge"
        monitor_spazio
