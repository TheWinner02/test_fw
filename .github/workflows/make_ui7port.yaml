name: Make OneUI 7.0 Port for Universal7885

on:
  workflow_dispatch:
    inputs:
      firmware_url:
        description: "Inserisci l'URL diretto del firmware EXYNOS (.zip o .tar.md5)"
        required: true
        type: string
      device_name:
        description: "Inserisci il nome del dispositivo della base"
        required: true
        type: string

jobs:
  OneUI7_Auto_Port_Universal7885:
    runs-on: ubuntu-24.04

    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4

      # ğŸ§¹ Pulizia extra disco (nuovi step)
      - name: Free disk space (1/3)
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          sudo docker builder prune -a

      - name: Free disk space (2/3)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true

      - name: Free disk space (3/3)
        uses: rokibhasansagar/slimhub_actions@main
        with:
          retain: 'compiler_cmake'

      # ğŸ“Š Crea funzione monitor_spazio
      - name: ğŸ“Š Crea funzione monitor_spazio
        run: |
          echo '#!/bin/bash
          FREE=$(df --output=avail -BG / | tail -1 | sed "s/G//")
          echo "ğŸ“Š Spazio libero: ${FREE} GB"
          if [ "$FREE" -lt 2 ]; then
            echo "âŒ ERRORE: spazio insufficiente (<2 GB)"
            exit 1
          fi' | sudo tee /usr/local/bin/monitor_spazio > /dev/null
          sudo chmod +x /usr/local/bin/monitor_spazio

      # âš™ï¸ Imposta nome dispositivo
      - name: ğŸ“± Imposta DEVICE_NAME
        run: |
          DEVICE_NAME="${{ github.event.inputs.device_name }}"
          echo "ğŸ“± Nome dispositivo: $DEVICE_NAME"
          echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV

      # âš™ï¸ Installazione dipendenze
      - name: âš™ï¸ Installa dipendenze necessarie
        run: |
          sudo apt update
          DEBIAN_FRONTEND=noninteractive sudo apt install -yq \
            unzip lz4 android-sdk-libsparse-utils attr zip wget git tar \
            f2fs-tools erofs-utils e2fsprogs python3 brotli erofsfuse fuse3
          sudo apt install -y linux-modules-extra-$(uname -r)
          sudo modprobe f2fs || echo "âš ï¸ Modulo F2FS non disponibile"
          sudo modprobe erofs || echo "âš ï¸ Modulo EROFS non disponibile"
          
          monitor_spazio
          
      # ğŸ“¥ Download firmware
      - name: ğŸ“¥ Scarica firmware
        run: |
          mkdir -p ACK
          echo "â¡ï¸ Download del firmware da: ${{ github.event.inputs.firmware_url }}"
          curl -L "${{ github.event.inputs.firmware_url }}" -o ACK/base.zip --progress-bar
          ls -lh ACK
          monitor_spazio
          
      # âš™ï¸ Copia file di configurazione personalizzati
      - name: âš™ï¸ Prepara file di configurazione per build system.img
        run: |
          cd ACK
          mkdir -p config
          cp -a fix/OneUI/UI7.0/Config/* config/ || echo "â„¹ï¸ Nessun file config trovato"
          ls -lh config/
          monitor_spazio
          
      # ğŸ“¦ Estrazione ZIP/TAR.MD5
      - name: ğŸ“¦ Estrai archivio principale
        run: |
          cd ACK
          if file base.zip | grep -q "gzip compressed"; then
            tar -xf base.zip
          else
            unzip base.zip
          fi
          rm -f base.zip
          monitor_spazio

      - name: ğŸ”¹ Estrai file .tar.md5
        run: |
          cd ACK
          tar --wildcards -xf *.tar.md5 'super.*.*'
          rm -f *.tar.md5
          monitor_spazio

      # ğŸ”¸ Decompressione super.img.lz4
      - name: ğŸ”¸ Decomprimi super.img.lz4
        run: |
          cd ACK
          if [ -f super.img.lz4 ]; then
            lz4 -d super.img.lz4 super.img.sparse
            rm -f super.img.lz4
          fi
          monitor_spazio

      # ğŸ” Conversione sparse â†’ raw
      - name: ğŸ” Converti sparse in raw
        run: |
          cd ACK
          simg2img super.img.sparse super.img
          rm -f super.img.sparse
          monitor_spazio

      # ğŸ§° LPUNPACK
      - name: ğŸ§° Scarica e prepara lpunpack
        run: |
          cd ACK
          git clone https://github.com/unix3dgforce/lpunpack.git
          monitor_spazio

      # ğŸ—‚ï¸ Estrazione partizioni da super.img
      - name: ğŸ—‚ï¸ Estrai partizioni
        run: |
          cd ACK
          mkdir out
          python3 lpunpack/lpunpack.py -p product,system super.img out/
          rm -f super.img
          ls -lh out
          monitor_spazio

      # ğŸ§© Estrazione system e product
      - name: ğŸ§© Estrazione system e product
        run: |
          cd ACK
          mkdir -p system_modified product_modified tmp_out

          for IMG in out/system.img out/product.img; do
            PART=$(basename $IMG .img)
            echo "ğŸ“‚ Estrazione $PART"

            mkdir -p tmp_out

            # ğŸ” Rilevamento filesystem
            FS=$(file -b out/system.img)

            echo "ğŸ” Risultato: $FS"

            if echo "$FS" | grep -qi "erofs"; then
              FS_TYPE="erofs"
            elif echo "$FS" | grep -qi "f2fs"; then
              FS_TYPE="f2fs"
            elif echo "$FS" | grep -qi "ext2\|ext3\|ext4"; then
              FS_TYPE="ext4"
            else
              echo "âš ï¸ Filesystem non riconosciuto, salto $IMG"
              continue
            fi

            echo "ğŸ“Œ Filesystem rilevato: $FS_TYPE"

            # ğŸ”¹ Montaggio in base al filesystem
            case "$FS_TYPE" in
              ext4|f2fs)
                echo "ğŸ”¹ Montaggio read-only di $FS_TYPE..."
                sudo mount -o ro,loop "$IMG" tmp_out || {
                  echo "âŒ Errore mount $FS_TYPE"; continue;
                }
                ;;
              erofs)
                echo "ğŸ”¹ Montaggio EROFS tramite erofsfuse..."
                erofsfuse "$IMG" tmp_out || {
                  echo "âŒ Errore mount EROFS"; continue;
                }
                ;;
            esac

            # ğŸ“¦ Copia in base alla partizione
            if [[ "$PART" == "system" ]]; then
              echo "ğŸ“¦ Copia partizione system"

              sudo cp -a --preserve=all tmp_out/system/* system_modified/ 2>/dev/null || true
              sudo cp -a --preserve=all tmp_out/system/system/* system_modified/system/ 2>/dev/null || true
            else
              echo "ğŸ“¦ Copia partizione product"
              sudo cp -a --preserve=all tmp_out/* product_modified/ 2>/dev/null || true
            fi

            # Fix permessi
            sudo find system_modified product_modified -exec chown -h $(whoami):$(whoami) {} \;

            # Smonta
            if [[ "$FS_TYPE" == "ext4" || "$FS_TYPE" == "f2fs" ]]; then
              sudo umount tmp_out || true
            else
              fusermount3 -u tmp_out || true
            fi
            sudo rm -rf tmp_out/*

          done

          sudo rm -f out/*.img
          echo "âœ… Estrazione completata"
          monitor_spazio


      # âš™ï¸ Applica modifiche OneUI 7.0
      - name: âš™ï¸ Applica patch OneUI
        run: |
          cd ACK
          echo "ğŸ“¦ Applico patch"

          # debloat
          chmod +x ../script/system/ui7_debloat.sh
          sudo bash ../script/system/ui7_debloat.sh
          
          # product
          ls product_modified
          sudo cp -a --preserve=all product_modified/app/Trichrome* system_modified/system/app/
          sudo cp -a --preserve=all product_modified/app/WebView* system_modified/system/app/
          sudo cp -a --preserve=all product_modified/priv-app/Ai* system_modified/system/priv-app/
          sudo cp -a --preserve=all product_modified/priv-app/Phonesky system_modified/system/priv-app/
          sudo cp -a --preserve=all product_modified/priv-app/PrivateComputeServices system_modified/system/priv-app/

          # system
          chmod +x ../script/system/ff.sh
          sudo bash ../script/system/ff.sh
          chmod +x ../script/system/prop.sh
          sudo bash ../script/system/prop.sh

          # common
          sudo cp -a --preserve=all ../common/product/overlay/* product_modified/overlay/
          sudo cp -a --preserve=all ../common/system/* system_modified/
          
          echo "âœ… Patch applicate"

      # ğŸ—ï¸ Ricompila system.img con configurazioni personalizzate
      - name: ğŸ—ï¸ Ricompila system.img con config e dimensione precisa
        run: |
          cd ACK
          echo "ğŸ§± Creazione system.img con context e config personalizzati..."
          
          # Applica mke2fs.conf se presente
          if [ -f config/mke2fs.conf ]; then
            sudo cp config/mke2fs.conf /etc/mke2fs.conf
            echo "âœ… mke2fs.conf applicato"
          fi

          # Crea system.img con filecontext e config precisi
          make_ext4fs -s -T 0 \
            -S config/system_file_contexts.txt \
            -C config/system_filesystem_config.txt \
            -l 4294967296 -a system out/system.img system_modified/

          # Applica eventuali feature aggiuntive definite in system_filesystem_features.txt
          if [ -f config/system_filesystem_features.txt ]; then
            echo "âš™ï¸ Applico system_filesystem_features.txt..."
            FEATURES=$(cat config/system_filesystem_features.txt | tr '\n' ',')
            tune2fs -O $FEATURES out/system.img || echo "âš ï¸ Feature non applicabili, continuo..."
          fi

          img2simg out/system.img out/system_sparse.img
          sudo rm -rf out/system.img system_modified
          monitor_spazio

      # ğŸ”„ Converti system_sparse.img â†’ .new.dat
      - name: ğŸ”„ Converti system_sparse.img â†’ .new.dat
        run: |
          cd ACK
          git clone https://github.com/xpirt/img2sdat.git
          cd img2sdat
          sed -i 's/import imp/import importlib as imp/' common.py
          python3 img2sdat.py ../out/system_sparse.img -o ../out -v 4
          sudo rm -f ../out/system_sparse.img
          cd ..
          monitor_spazio

      # ğŸ—œï¸ Compressione output
      - name: ğŸ—œï¸ Comprimi risultati finali
        run: |
          cd ACK
          mkdir -p out/product
          sudo cp -a --preserve=all product_modified/* out/product/
          sudo rm -rf product_modified
          sudo cp -a --preserve=all ../common/vendor out/
          sudo cp -a --preserve=all ../common/device out/
          sudo cp -a --preserve=all ../common/inf/$DEVICE_NAME/* out/
          cd out
          sudo zip -r -9 ../Port.zip *
          cd ..
          sudo rm -rf out
          ls -lh Port.zip
          monitor_spazio

      # â˜ï¸ Upload su SourceForge
      - name: â˜ï¸ Upload su SourceForge
        run: |
          cd ACK
          mkdir -p ~/.ssh
          echo "${{ secrets.SF_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan frs.sourceforge.net >> ~/.ssh/known_hosts
          scp Port.zip thewinner02@frs.sourceforge.net:/home/frs/project/oneui-ports/test/
          echo "âœ… Upload completato su SourceForge"
          monitor_spazio
