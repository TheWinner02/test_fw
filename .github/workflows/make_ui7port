name: Make OneUI 7.0 Port for Universall7885

on:
  workflow_dispatch:
    inputs:
      firmware_url:
        description: "Inserisci l'URL diretto del firmware EXYNOS(.zip o .tar.md5)"
        required: true
        type: string

jobs:
  estrai_firmware:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¦ Checkout Repository
      uses: actions/checkout@v4

    # ğŸ§¹ PULIZIA E SPAZIO
    - name: ğŸ”§ Libera spazio su disco
      run: |
        echo "ğŸ§¹ Rimozione pacchetti non necessari..."
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        sudo docker system prune -a -f
        sudo apt clean
        df -h /

    - name: ğŸ“Š Crea funzione monitor_spazio
      run: |
        echo '#!/bin/bash
        FREE=$(df --output=avail -BG / | tail -1 | sed "s/G//")
        echo "ğŸ“Š Spazio libero: ${FREE} GB"
        if [ "$FREE" -lt 2 ]; then
          echo "âŒ ERRORE: spazio insufficiente (<2 GB)"
          exit 1
        fi' | sudo tee /usr/local/bin/monitor_spazio > /dev/null
        sudo chmod +x /usr/local/bin/monitor_spazio

    # âš™ï¸ INSTALLAZIONE DIPENDENZE
    - name: âš™ï¸ Installa dipendenze necessarie
      run: |
        sudo apt update
        DEBIAN_FRONTEND=noninteractive sudo apt install -yq \
          unzip lz4 android-sdk-libsparse-utils attr zip wget git tar e2fsprogs python3
        monitor_spazio

    # ğŸ“¥ DOWNLOAD FIRMWARE
    - name: ğŸ“¥ Scarica firmware
      run: |
        mkdir -p firmware
        echo "â¡ï¸ Download del firmware da: ${{ github.event.inputs.firmware_url }}"
        curl -L "${{ github.event.inputs.firmware_url }}" -o firmware/firmware.zip --progress-bar
        ls -lh firmware
        monitor_spazio

    # ğŸ“¦ ESTRAZIONE ZIP/TAR.MD5
    - name: ğŸ“¦ Estrai archivio principale
      run: |
        cd firmware
        if file firmware.zip | grep -q "gzip compressed"; then
          echo "ğŸ“¦ File TAR.MD5 rilevato, estrazione..."
          tar -xf firmware.zip
        else
          echo "ğŸ“¦ File ZIP rilevato, estrazione..."
          unzip firmware.zip
        fi
        rm -f firmware.zip
        echo "âœ… Estrazione completata"
        monitor_spazio

    - name: ğŸ”¹ Estrai file .tar.md5
      run: |
        cd firmware
        for f in *.tar.md5; do
          echo "ğŸ“‚ Estrazione di $f"
          tar -xf "$f"
          rm -f "$f"
        done
        echo "âœ… Tutti i file TAR.MD5 estratti"
        monitor_spazio

    # ğŸ”¸ DECOMPRESSIONE SUPER.IMG.LZ4
    - name: ğŸ”¸ Decomprimi super.img.lz4
      run: |
        cd firmware
        if [ -f super.img.lz4 ]; then
          echo "ğŸ”¹ Decompressione super.img.lz4"
          lz4 -d super.img.lz4 super.img.sparse
          rm -f super.img.lz4
        fi
        mv super.img.sparse ../super.img.sparse || true
        cd ..
        rm -rf firmware
        monitor_spazio

    # ğŸ” CONVERSIONE SPARSE â†’ RAW
    - name: ğŸ” Converti sparse in raw
      run: |
        echo "ğŸ” Conversione super.img.sparse â†’ super.img"
        simg2img super.img.sparse super.img
        rm -f super.img.sparse
        ls -lh super.img
        monitor_spazio

    # ğŸ§° LPUNPACK
    - name: ğŸ§° Scarica e prepara lpunpack
      run: |
        git clone https://github.com/unix3dgforce/lpunpack.git
        monitor_spazio

    # ğŸ—‚ï¸ ESTRAZIONE PARTIZIONI
    - name: ğŸ—‚ï¸ Estrai partizioni da super.img
      run: |
        mkdir out
        echo "ğŸ“‚ Estrazione di system.img da super.img..."
        python3 lpunpack/lpunpack.py -p system super.img out/
        rm -f super.img
        ls -lh out
        monitor_spazio

    # ğŸ—œï¸ COMPRESSIONE OUTPUT
    - name: ğŸ—œï¸ Comprimi risultati finali
      run: |
        echo "ğŸ—œï¸ Compressione file..."
        cd out
        zip -9 ../firmware_parts.zip system.img
        cd ..
        ls -lh firmware_parts.zip
        monitor_spazio

    # â˜ï¸ UPLOAD SU SOURCEFORGE
    - name: ğŸ” Configura SSH e carica su SourceForge
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SF_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan frs.sourceforge.net >> ~/.ssh/known_hosts
        scp firmware_parts.zip thewinner02@frs.sourceforge.net:/home/frs/project/oneui-ports/test/
        echo "âœ… Upload completato su SourceForge"
        monitor_spazio
