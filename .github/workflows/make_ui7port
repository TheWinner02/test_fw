name: Make OneUI 7.0 Port for Universall7885

on:
  workflow_dispatch:
    inputs:
      firmware_url:
        description: "Inserisci l'URL diretto del firmware EXYNOS(.zip o .tar.md5)"
        required: true
        type: string

jobs:
  estrai_firmware:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¦ Checkout Repository
      uses: actions/checkout@v4

    # ğŸ§¹ PULIZIA E SPAZIO
    - name: ğŸ”§ Libera spazio su disco
      run: |
        echo "ğŸ§¹ Rimozione pacchetti non necessari..."
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        sudo docker system prune -a -f
        sudo apt clean
        df -h /

    - name: ğŸ“Š Crea funzione monitor_spazio
      run: |
        echo '#!/bin/bash
        FREE=$(df --output=avail -BG / | tail -1 | sed "s/G//")
        echo "ğŸ“Š Spazio libero: ${FREE} GB"
        if [ "$FREE" -lt 2 ]; then
          echo "âŒ ERRORE: spazio insufficiente (<2 GB)"
          exit 1
        fi' | sudo tee /usr/local/bin/monitor_spazio > /dev/null
        sudo chmod +x /usr/local/bin/monitor_spazio

    # âš™ï¸ INSTALLAZIONE DIPENDENZE
    - name: âš™ï¸ Installa dipendenze necessarie
      run: |
        sudo apt update
        DEBIAN_FRONTEND=noninteractive sudo apt install -yq \
          unzip lz4 android-sdk-libsparse-utils attr zip wget git tar f2fs-tools erofs-utils e2fsprogs python3 brotli
        monitor_spazio

    # ğŸ“¥ DOWNLOAD FIRMWARE
    - name: ğŸ“¥ Scarica firmware
      run: |
        mkdir -p ACK
        echo "â¡ï¸ Download del firmware da: ${{ github.event.inputs.firmware_url }}"
        curl -L "${{ github.event.inputs.firmware_url }}" -o ACK/base.zip --progress-bar
        ls -lh ACK
        monitor_spazio

    # ğŸ“¦ ESTRAZIONE ZIP/TAR.MD5
    - name: ğŸ“¦ Estrai archivio principale
      run: |
        cd ACK
        if file base.zip | grep -q "gzip compressed"; then
          echo "ğŸ“¦ File TAR.MD5 rilevato, estrazione..."
          tar -xf base.zip
        else
          echo "ğŸ“¦ File ZIP rilevato, estrazione..."
          unzip base.zip
        fi
        rm -f base.zip
        echo "âœ… Estrazione completata"
        monitor_spazio

    - name: ğŸ”¹ Estrai file .tar.md5
      run: |
        for f in *.tar.md5; do
          echo "ğŸ“‚ Estrazione di $f"
          tar -xf "$f" -wildcards super.*.*
          rm -f "$f"
        done
        echo "âœ… File TAR.MD5 estratti"
        monitor_spazio

    # ğŸ”¸ DECOMPRESSIONE SUPER.IMG.LZ4
    - name: ğŸ”¸ Decomprimi super.img.lz4
      run: |
        if [ -f super.img.lz4 ]; then
          echo "ğŸ”¹ Decompressione super.img.lz4"
          lz4 -d super.img.lz4 super.img.sparse
          rm -f super.img.lz4
        fi
        monitor_spazio

    # ğŸ” CONVERSIONE SPARSE â†’ RAW
    - name: ğŸ” Converti sparse in raw
      run: |
        echo "ğŸ” Conversione super.img.sparse â†’ super.img"
        simg2img super.img.sparse super.img
        rm -f super.img.sparse
        ls -lh super.img
        monitor_spazio

    # ğŸ§° LPUNPACK
    - name: ğŸ§° Scarica e prepara lpunpack
      run: |
        git clone https://github.com/unix3dgforce/lpunpack.git
        monitor_spazio

    # ğŸ—‚ï¸ ESTRAZIONE PARTIZIONI
    - name: ğŸ—‚ï¸ Estrai partizioni da super.img
      run: |
        mkdir out
        echo "ğŸ“‚ Estrazione da super.img..."
        python3 lpunpack/lpunpack.py -p product,system super.img out/
        rm -f super.img
        ls -lh out
        monitor_spazio

    #########################################################################
    # âš™ï¸ NUOVA SEZIONE: RICOMPILE SYSTEM.IMG RAW â†’ SYSTEM.NEW.DAT.BR
    #########################################################################

    - name: âš™ï¸ Rileva filesystem di system.img
      id: detect
      run: |
        TYPE=$(file out/system.img | grep -oE 'ext4|f2fs|erofs' || true)
        echo "âœ… Filesystem rilevato: $TYPE"
        echo "type=$TYPE" >> $GITHUB_OUTPUT
        monitor_spazio

    - name: ğŸ§© Monta e modifica system.img
      run: |
        TYPE=${{ steps.detect.outputs.type }}
        mkdir system_mount system_modified && mkdir product_mount product_modified 

        if [ "$TYPE" = "ext4" ]; then
          sudo mount -o loop out/system.img system_mount && sudo mount -o loop out/product.img product_mount
        elif [ "$TYPE" = "f2fs" ]; then
          sudo mount -t f2fs -o loop out/system.img system_mount && sudo mount -t f2fs -o loop out/product.img product_mount
        elif [ "$TYPE" = "erofs" ]; then
          sudo mount -t erofs -o loop out/system.img system_mount && sudo mount -t erofs -o loop out/product.img product_mount
        fi

        echo "ğŸ“‚ Copia contenuto di system.img..."
        sudo cp -a system_mount/* system_modified/ && sudo cp -a product_mount/* product_modified/
        sudo umount system_mount product_mount
        sudo rm -f out/*
        echo "âœ… Contenuto estratto in system_modified/"
        monitor_spazio

    - name: ğŸ“ Applica correzzioni
      run: |
        echo "âš™ï¸ OneUI 7.0 Port AutoBuild..."
        chmod +x ../script/system/ui7_debloat.sh
        sudo bash ../script/system/ui7_debloat.sh
        
    - name: ğŸ—ï¸ Compressione system.img
      run: |
        echo "âš™ï¸ Ricompilazione filesystem: $TYPE"
        
        # ğŸ”¹ Crea file vuoto da 4GB
        dd if=/dev/zero of=out/system.img bs=1M count=4096 status=progress

        # ğŸ”¹ Format ext4 con label system
        mkfs.ext4 -F -L system out/system.img

        # ğŸ”¹ Monta e copia i file dentro
        sudo mkdir -p /mnt/system
        sudo mount -o loop out/system.img /mnt/system
        echo "ğŸ“‚ Copia file in system..."
        sudo cp -a system_modified/* /mnt/system/
        sudo umount /mnt/system
        sudo rm -rf /mnt/system && sudo rm -rf system_modified

        # ğŸ”¹ Converte in immagine sparse
        echo "ğŸ” Conversione in sparse image..."
        img2simg out/system.img out/system_sparse.img
        echo "âœ… Ricompilazione completata"
        sudo rm -f out/system.img
        ls -lh out/system_sparse.img
        monitor_spazio

    - name: ğŸ”„ Converti system_sparse.img â†’ .new.dat
      run: |
        git clone https://github.com/xpirt/img2sdat.git
        cd img2sdat
        python3 img2sdat.py ../out/system_sparse.img -o ../ -v 4
        ls -lh system.new.dat
        monitor_spazio

    # â˜ï¸ UPLOAD SU SOURCEFORGE
    - name: ğŸ” Configura SSH e carica su SourceForge
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SF_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan frs.sourceforge.net >> ~/.ssh/known_hosts
        scp out/system.new.dat.br thewinner02@frs.sourceforge.net:/home/frs/project/oneui-ports/test/
        echo "âœ… Upload completato su SourceForge"
        monitor_spazio
